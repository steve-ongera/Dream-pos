{% extends 'base.html' %}

{% block content %}
<style>
    .report-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%);
        border-radius: 12px;
        color: white;
        box-shadow: var(--shadow);
    }
    
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        transition: transform 0.3s ease;
        border: none;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: var(--text-light);
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 24px;
    }
    
    .chart-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .chart-wrapper-small {
        position: relative;
        height: 250px;
        width: 100%;
    }
    
    .chart-wrapper-medium {
        position: relative;
        height: 280px;
        width: 100%;
    }
    
    .chart-wrapper canvas,
    .chart-wrapper-small canvas,
    .chart-wrapper-medium canvas {
        max-height: 100% !important;
        max-width: 100% !important;
    }
    
    .icon-wrapper {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
        margin-bottom: 16px;
    }
    
    .bg-gradient-primary { background: linear-gradient(135deg, var(--primary-color), var(--dark-color)); }
    .bg-gradient-success { background: linear-gradient(135deg, var(--success-color), #a8e6cf); }
    .bg-gradient-warning { background: linear-gradient(135deg, var(--warning-color), var(--secondary-color)); }
    .bg-gradient-info { background: linear-gradient(135deg, var(--primary-color), #00f2fe); }
    
    .period-selector {
        background: white;
        border-radius: 8px;
        padding: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 24px;
    }
    
    .btn-period {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-light);
        padding: 6px 12px;
        margin: 0 4px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-period.active,
    .btn-period:hover {
        background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
        border-color: var(--primary-color);
        color: white;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        z-index: 10;
    }
    
    .spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .insight-card {
        background: linear-gradient(135deg, var(--secondary-color), var(--warning-color));
        color: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
    }
    
    .insight-icon {
        font-size: 1.5rem;
        margin-bottom: 8px;
    }
    
    .btn-outline {
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }
    
    .btn-outline:hover {
        background-color: var(--light-color);
    }
    
    @media (max-width: 768px) {
        .chart-wrapper {
            height: 250px;
        }
        
        .chart-wrapper-small {
            height: 220px;
        }
        
        .chart-wrapper-medium {
            height: 240px;
        }
    }
</style>

<div class="container-fluid py-3">
    <!-- Page Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="report-header p-3">
                <h1 class="mb-0 h4">
                    <i class="fas fa-chart-line me-2"></i>Sales Dashboard
                </h1>
                <p class="mb-0 small opacity-85">Key performance metrics and analytics</p>
            </div>
        </div>
    </div>
    
    <!-- Period Selector -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="period-selector text-center">
                <button class="btn btn-period active" data-period="today">Today</button>
                <button class="btn btn-period" data-period="week">Week</button>
                <button class="btn btn-period" data-period="month">Month</button>
                <button class="btn btn-period" data-period="year">Year</button>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-3" id="statsContainer">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="icon-wrapper bg-gradient-primary">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stats-number text-primary" id="todaySales">$0</div>
                <div class="stats-label">Today's Sales</div>
                <small class="text-success" id="salesGrowth">+0% from yesterday</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="icon-wrapper bg-gradient-success">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stats-number text-success" id="todayOrders">0</div>
                <div class="stats-label">Today's Orders</div>
                <small class="text-info" id="avgOrderValue">Avg: $0</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="icon-wrapper bg-gradient-warning">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-number text-warning" id="totalCustomers">0</div>
                <div class="stats-label">Total Customers</div>
                <small class="text-primary" id="topCustomer">Top: N/A</small>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="icon-wrapper bg-gradient-info">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stats-number text-info" id="totalProducts">0</div>
                <div class="stats-label">Products</div>
                <small class="text-danger" id="lowStockAlert">0 low stock</small>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row">
        <!-- Sales Trend Chart -->
        <div class="col-lg-8 mb-3">
            <div class="chart-container position-relative">
                <div class="loading-overlay d-none" id="salesChartLoading">
                    <div class="spinner"></div>
                </div>
                <div class="chart-title">
                    <i class="fas fa-chart-line me-2"></i>Sales Trend
                </div>
                <div class="chart-wrapper">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Daily Sales Analysis -->
        <div class="col-lg-4 mb-3">
            <div class="chart-container position-relative">
                <div class="loading-overlay d-none" id="dailyChartLoading">
                    <div class="spinner"></div>
                </div>
                <div class="chart-title">
                    <i class="fas fa-calendar-week me-2"></i>Sales by Day
                </div>
                <div class="chart-wrapper-small">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Second Charts Row -->
    <div class="row">
        <!-- Top Products Chart -->
        <div class="col-lg-6 mb-3">
            <div class="chart-container position-relative">
                <div class="loading-overlay d-none" id="productsChartLoading">
                    <div class="spinner"></div>
                </div>
                <div class="chart-title">
                    <i class="fas fa-trophy me-2"></i>Top Products
                </div>
                <div class="chart-wrapper-medium">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Insights Panel -->
        <div class="col-lg-6 mb-3">
            <div class="insight-card">
                <div class="insight-icon">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <h5>Business Insights</h5>
                <div id="insightsContent">
                    <p class="small mb-1"><i class="fas fa-star me-2"></i>Loading insights...</p>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="stats-card">
                <h6 class="mb-2">Quick Actions</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline" onclick="exportReport('pdf')">
                        <i class="fas fa-file-pdf me-2"></i>Export PDF
                    </button>
                    <button class="btn btn-outline" onclick="exportReport('excel')">
                        <i class="fas fa-file-excel me-2"></i>Export Excel
                    </button>
                    <button class="btn btn-outline" onclick="printReport()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesTrendChart, dailySalesChart, topProductsChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSummaryStats();
    loadSalesData();
    loadTopProducts();
    loadDailySalesAnalysis();
    
    // Period selector event listeners
    document.querySelectorAll('.btn-period').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            // Refresh data based on selected period
            refreshData(this.dataset.period);
        });
    });
});

// Load summary statistics
function loadSummaryStats() {
    fetch('/reports/sales-summary/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('todaySales').textContent = `$${data.today_sales.toFixed(2)}`;
            document.getElementById('todayOrders').textContent = data.today_orders;
            document.getElementById('totalCustomers').textContent = data.total_customers;
            document.getElementById('totalProducts').textContent = data.total_products;
            document.getElementById('topCustomer').textContent = `Top: ${data.top_customer}`;
            document.getElementById('lowStockAlert').textContent = `${data.low_stock_products} low stock`;
            
            if (data.today_orders > 0) {
                const avgOrderValue = data.today_sales / data.today_orders;
                document.getElementById('avgOrderValue').textContent = `Avg: $${avgOrderValue.toFixed(2)}`;
            }
            
            // Calculate growth percentage (mock calculation)
            const growth = Math.random() * 20 - 10; // Random between -10 and 10
            const growthElement = document.getElementById('salesGrowth');
            growthElement.textContent = `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}% from yesterday`;
            growthElement.className = growth >= 0 ? 'text-success' : 'text-danger';
            
            generateInsights(data);
        })
        .catch(error => console.error('Error loading stats:', error));
}

// Load sales trend data
function loadSalesData() {
    showLoading('salesChartLoading', true);
    
    fetch('/reports/sales-data/')
        .then(response => response.json())
        .then(data => {
            showLoading('salesChartLoading', false);
            createSalesTrendChart(data);
        })
        .catch(error => {
            console.error('Error loading sales data:', error);
            showLoading('salesChartLoading', false);
        });
}

// Load top products data
function loadTopProducts() {
    showLoading('productsChartLoading', true);
    
    fetch('/reports/top-products/')
        .then(response => response.json())
        .then(data => {
            showLoading('productsChartLoading', false);
            createTopProductsChart(data);
        })
        .catch(error => {
            console.error('Error loading products data:', error);
            showLoading('productsChartLoading', false);
        });
}

// Load daily sales analysis
function loadDailySalesAnalysis() {
    showLoading('dailyChartLoading', true);
    
    fetch('/reports/daily-analysis/')
        .then(response => response.json())
        .then(data => {
            showLoading('dailyChartLoading', false);
            createDailySalesChart(data);
        })
        .catch(error => {
            console.error('Error loading daily analysis:', error);
            showLoading('dailyChartLoading', false);
        });
}

// Create sales trend chart
function createSalesTrendChart(data) {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    
    if (salesTrendChart) {
        salesTrendChart.destroy();
    }
    
    salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.months.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
            }),
            datasets: [{
                label: 'Sales Revenue',
                data: data.sales,
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }, {
                label: 'Number of Orders',
                data: data.orders,
                borderColor: 'rgb(118, 75, 162)',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                borderWidth: 2,
                yAxisID: 'y1',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // This prevents height growth
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

// Create top products chart
function createTopProductsChart(data) {
    const ctx = document.getElementById('topProductsChart').getContext('2d');
    
    if (topProductsChart) {
        topProductsChart.destroy();
    }
    
    const colors = [
        'rgba(102, 126, 234, 0.8)',
        'rgba(118, 75, 162, 0.8)',
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(199, 199, 199, 0.8)',
        'rgba(83, 102, 255, 0.8)'
    ];
    
    topProductsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.products,
            datasets: [{
                label: 'Quantity Sold',
                data: data.quantities,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // This prevents height growth
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const revenue = data.revenues[context.dataIndex];
                            return `Revenue: $${revenue.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// Create daily sales chart
function createDailySalesChart(data) {
    const ctx = document.getElementById('dailySalesChart').getContext('2d');
    
    if (dailySalesChart) {
        dailySalesChart.destroy();
    }
    
    dailySalesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.days,
            datasets: [{
                data: data.sales,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(102, 126, 234, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // This prevents height growth
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Generate business insights
function generateInsights(data) {
    const insights = [];
    
    if (data.today_orders > data.month_orders / 30) {
        insights.push("📈 Today's performance is above average!");
    }
    
    if (data.low_stock_products > 0) {
        insights.push(`⚠️ ${data.low_stock_products} products need restocking`);
    }
    
    if (data.total_customers > 100) {
        insights.push("🎉 Great customer base! Consider loyalty programs");
    }
    
    const avgOrderValue = data.month_sales / data.month_orders;
    if (avgOrderValue > 50) {
        insights.push("💰 High average order value - excellent!");
    }
    
    const insightsHtml = insights.length > 0 ? 
        insights.map(insight => `<p><i class="fas fa-star me-2"></i>${insight}</p>`).join('') :
        '<p><i class="fas fa-info-circle me-2"></i>Keep tracking your performance for more insights!</p>';
    
    document.getElementById('insightsContent').innerHTML = insightsHtml;
}

// Utility functions
function showLoading(elementId, show) {
    const element = document.getElementById(elementId);
    if (show) {
        element.classList.remove('d-none');
    } else {
        element.classList.add('d-none');
    }
}

function refreshData(period) {
    // This would typically filter data based on the selected period
    console.log('Refreshing data for period:', period);
    // For now, just reload all data
    loadSummaryStats();
    loadSalesData();
    loadTopProducts();
    loadDailySalesAnalysis();
}

function exportReport(format) {
    alert(`Exporting report as ${format.toUpperCase()}... (Feature to be implemented)`);
}

function printReport() {
    window.print();
}
</script>
{% endblock %}
{% extends 'base.html' %}

{% block content %}
<style>
    .customer-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .customer-card:hover {
        transform: translateY(-5px);
    }
    
    .loyalty-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .loyalty-bronze { background: #cd7f32; color: white; }
    .loyalty-silver { background: #c0c0c0; color: #333; }
    .loyalty-gold { background: #ffd700; color: #333; }
    .loyalty-platinum { background: #e5e4e2; color: #333; }
    
    .btn-gradient {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(45deg, #764ba2, #667eea);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        color: white;
    }
    
    .search-box {
        border-radius: 25px;
        border: 2px solid #667eea;
        padding: 12px 20px;
        transition: all 0.3s ease;
    }
    
    .search-box:focus {
        outline: none;
        border-color: #764ba2;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }
    
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.1);
        transform: scale(1.01);
        transition: all 0.2s ease;
    }
    
    .action-btn {
        margin: 0 2px;
        padding: 5px 10px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-view { background: #17a2b8; color: white; }
    .btn-edit { background: #28a745; color: white; }
    .btn-delete { background: #dc3545; color: white; }
    
    .action-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    .stats-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        border-left: 4px solid #667eea;
        transition: transform 0.3s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-3px);
    }
    
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="customer-card p-4">
                <h1 class="mb-0">
                    <i class="fas fa-users me-3"></i>Customer Management
                </h1>
                <p class="mb-0 opacity-75">Manage your customers and track their loyalty</p>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-4" id="statsContainer">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="text-primary mb-2" id="totalCustomers">0</h3>
                <p class="mb-0 text-muted">Total Customers</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="text-success mb-2" id="goldCustomers">0</h3>
                <p class="mb-0 text-muted">Gold+ Members</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="text-warning mb-2" id="totalSpent">$0</h3>
                <p class="mb-0 text-muted">Total Revenue</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <h3 class="text-info mb-2" id="avgSpent">$0</h3>
                <p class="mb-0 text-muted">Avg. Spending</p>
            </div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="input-group">
                <span class="input-group-text bg-light border-0">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control search-box border-start-0" 
                       placeholder="Search customers by name, email, or phone..." id="searchCustomer">
            </div>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="openAddModal()">
                <i class="fas fa-plus me-2"></i>Add New Customer
            </button>
        </div>
    </div>
    
    <!-- Customers Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="customersTable">
                    <thead class="table-light">
                        <tr>
                            <th>Customer</th>
                            <th>Contact</th>
                            <th>Loyalty</th>
                            <th>Points</th>
                            <th>Total Spent</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic content will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Customer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="customerPhone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="loyaltyTier" class="form-label">Loyalty Tier</label>
                            <select class="form-select" id="loyaltyTier">
                                <option value="bronze">Bronze</option>
                                <option value="silver">Silver</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="loyaltyPoints" class="form-label">Loyalty Points</label>
                            <input type="number" class="form-control" id="loyaltyPoints" value="0" min="0">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="customerAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="customerAddress" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" onclick="saveCustomer()">
                    <span id="saveSpinner" class="loading d-none"></span>
                    <span id="saveText">Save Customer</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Customer Modal -->
<div class="modal fade" id="viewCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerDetails">
                <!-- Customer details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentCustomerId = null;
let customers = [];

// Load customers on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCustomers();
});

// Load customers via AJAX
function loadCustomers() {
    fetch('/customers/ajax/')
        .then(response => response.json())
        .then(data => {
            customers = data.data;
            displayCustomers(customers);
            updateStats(customers);
        })
        .catch(error => {
            console.error('Error loading customers:', error);
            showAlert('Error loading customers', 'danger');
        });
}

// Display customers in table
function displayCustomers(customerList) {
    const tbody = document.querySelector('#customersTable tbody');
    tbody.innerHTML = '';
    
    customerList.forEach(customer => {
        const row = `
            <tr class="fade-in">
                <td>
                    <div class="d-flex align-items-center">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px; color: white; font-weight: bold;">
                            ${customer.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h6 class="mb-0">${customer.name}</h6>
                            <small class="text-muted">ID: #${customer.id}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        ${customer.email ? `<div><i class="fas fa-envelope me-2"></i>${customer.email}</div>` : ''}
                        ${customer.phone ? `<div><i class="fas fa-phone me-2"></i>${customer.phone}</div>` : ''}
                    </div>
                </td>
                <td>
                    <span class="loyalty-badge loyalty-${customer.loyalty_tier.toLowerCase()}">
                        ${customer.loyalty_tier}
                    </span>
                    <br><small class="text-muted">${customer.discount_percentage}% discount</small>
                </td>
                <td>
                    <span class="badge bg-info">${customer.loyalty_points}</span>
                </td>
                <td>
                    <strong>$${parseFloat(customer.total_spent).toFixed(2)}</strong>
                </td>
                <td>
                    <small class="text-muted">${new Date(customer.created_at).toLocaleDateString()}</small>
                </td>
                <td>
                    <button class="action-btn btn-view" onclick="viewCustomer(${customer.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn btn-edit" onclick="editCustomer(${customer.id})" title="Edit Customer">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn btn-delete" onclick="deleteCustomer(${customer.id})" title="Delete Customer">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// Update statistics
function updateStats(customerList) {
    const totalCustomers = customerList.length;
    const goldCustomers = customerList.filter(c => ['gold', 'platinum'].includes(c.loyalty_tier.toLowerCase())).length;
    const totalSpent = customerList.reduce((sum, c) => sum + parseFloat(c.total_spent), 0);
    const avgSpent = totalCustomers > 0 ? totalSpent / totalCustomers : 0;
    
    document.getElementById('totalCustomers').textContent = totalCustomers;
    document.getElementById('goldCustomers').textContent = goldCustomers;
    document.getElementById('totalSpent').textContent = `$${totalSpent.toFixed(2)}`;
    document.getElementById('avgSpent').textContent = `$${avgSpent.toFixed(2)}`;
}

// Search functionality
document.getElementById('searchCustomer').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = customers.filter(customer => 
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.email.toLowerCase().includes(searchTerm) ||
        customer.phone.toLowerCase().includes(searchTerm)
    );
    displayCustomers(filtered);
});

// Open add modal
function openAddModal() {
    currentCustomerId = null;
    document.getElementById('modalTitle').textContent = 'Add New Customer';
    document.getElementById('customerForm').reset();
    document.getElementById('saveText').textContent = 'Save Customer';
}

// View customer details
function viewCustomer(customerId) {
    fetch(`/customers/${customerId}/detail/`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const customer = result.data;
                document.getElementById('customerDetails').innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h4 class="text-primary mb-3">${customer.name}</h4>
                            <div class="row mb-3">
                                <div class="col-sm-4 fw-bold">Email:</div>
                                <div class="col-sm-8">${customer.email || 'Not provided'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-4 fw-bold">Phone:</div>
                                <div class="col-sm-8">${customer.phone || 'Not provided'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-4 fw-bold">Address:</div>
                                <div class="col-sm-8">${customer.address || 'Not provided'}</div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-4 fw-bold">Member Since:</div>
                                <div class="col-sm-8">${new Date(customer.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <span class="loyalty-badge loyalty-${customer.loyalty_tier} mb-3 d-inline-block">
                                        ${customer.loyalty_tier.toUpperCase()}
                                    </span>
                                    <h5 class="text-primary">${customer.loyalty_points} Points</h5>
                                    <p class="text-muted mb-0">Total Spent: <strong>$${customer.total_spent}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('viewCustomerModal')).show();
            } else {
                showAlert('Error loading customer details', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading customer details', 'danger');
        });
}

// Edit customer
function editCustomer(customerId) {
    currentCustomerId = customerId;
    const customer = customers.find(c => c.id === customerId);
    
    if (customer) {
        document.getElementById('modalTitle').textContent = 'Edit Customer';
        document.getElementById('customerName').value = customer.name;
        document.getElementById('customerEmail').value = customer.email;
        document.getElementById('customerPhone').value = customer.phone;
        document.getElementById('customerAddress').value = customer.address;
        document.getElementById('loyaltyTier').value = customer.loyalty_tier.toLowerCase();
        document.getElementById('loyaltyPoints').value = customer.loyalty_points;
        document.getElementById('saveText').textContent = 'Update Customer';
        
        new bootstrap.Modal(document.getElementById('customerModal')).show();
    }
}

// Save customer (create or update)
function saveCustomer() {
    const formData = {
        name: document.getElementById('customerName').value,
        email: document.getElementById('customerEmail').value,
        phone: document.getElementById('customerPhone').value,
        address: document.getElementById('customerAddress').value,
        loyalty_tier: document.getElementById('loyaltyTier').value,
        loyalty_points: document.getElementById('loyaltyPoints').value
    };
    
    // Show loading spinner
    document.getElementById('saveSpinner').classList.remove('d-none');
    document.getElementById('saveText').textContent = currentCustomerId ? 'Updating...' : 'Saving...';
    
    const url = currentCustomerId ? 
        `/customers/${currentCustomerId}/update/` : 
        '/customers/create/';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('saveSpinner').classList.add('d-none');
        document.getElementById('saveText').textContent = currentCustomerId ? 'Update Customer' : 'Save Customer';
        
        if (result.success) {
            showAlert(result.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
            loadCustomers();
        } else {
            showAlert(result.error || 'An error occurred', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('saveSpinner').classList.add('d-none');
        document.getElementById('saveText').textContent = currentCustomerId ? 'Update Customer' : 'Save Customer';
        showAlert('An error occurred while saving', 'danger');
    });
}

// Delete customer
function deleteCustomer(customerId) {
    if (confirm('Are you sure you want to delete this customer? This action cannot be undone.')) {
        fetch(`/customers/${customerId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(result.message, 'success');
                loadCustomers();
            } else {
                showAlert(result.error || 'Error deleting customer', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting customer', 'danger');
        });
    }
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Inventory Management - Dreams POS{% endblock %}

{% block search_bar %}
<div class="input-group">
    <input type="text" class="form-control search-bar" placeholder="Search products by name or SKU..." 
           id="inventorySearch" value="{{ search_query }}">
    <button class="btn btn-outline-secondary" type="button" onclick="searchInventory()">
        <i class="fas fa-search"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">Inventory Management</h4>
                <p class="text-muted mb-0">Manage your product stock and inventory levels</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#stockInModal">
                    <i class="fas fa-plus me-2"></i>Stock In
                </button>
                <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#stockOutModal">
                    <i class="fas fa-minus me-2"></i>Stock Out
                </button>
                <button class="btn btn-outline-primary" onclick="exportInventory()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <a href="#" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add Product
                </a>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-3 p-3 shadow-sm mb-4">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" name="category" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Stock Status</label>
                    <select class="form-select" name="stock_status" onchange="this.form.submit()">
                        <option value="">All Products</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                        <option value="in_stock">In Stock</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sort By</label>
                    <select class="form-select" name="sort_by" onchange="this.form.submit()">
                        <option value="name">Name (A-Z)</option>
                        <option value="-name">Name (Z-A)</option>
                        <option value="stock_quantity">Stock (Low to High)</option>
                        <option value="-stock_quantity">Stock (High to Low)</option>
                        <option value="price">Price (Low to High)</option>
                        <option value="-price">Price (High to Low)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Product name or SKU" value="{{ search_query }}">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-boxes text-primary fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Total Products</h6>
                            <h4 class="fw-bold text-primary mb-0">{{ products.count }}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-check-circle text-success fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">In Stock</h6>
                            <h4 class="fw-bold text-success mb-0">
                                {% for product in products %}
                                    {% if product.stock_quantity > product.min_stock_level %}1{% endif %}
                                {% endfor %}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-exclamation-triangle text-warning fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Low Stock</h6>
                            <h4 class="fw-bold text-warning mb-0">
                                {% for product in products %}
                                    {% if product.is_low_stock %}1{% endif %}
                                {% endfor %}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-times-circle text-danger fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Out of Stock</h6>
                            <h4 class="fw-bold text-danger mb-0">
                                {% for product in products %}
                                    {% if product.stock_quantity == 0 %}1{% endif %}
                                {% endfor %}
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-3 shadow-sm">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0">Products Inventory</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-view="table">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="btn btn-outline-secondary" data-view="grid">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Min. Level</th>
                            <th>Unit Price</th>
                            <th>Cost Price</th>
                            <th>Stock Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if product.image %}
                                        <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                             class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-semibold">{{ product.name }}</div>
                                        {% if product.description %}
                                            <small class="text-muted">{{ product.description|truncatechars:30 }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ product.sku }}</span>
                            </td>
                            <td>{{ product.category.name }}</td>
                            <td>
                                <span class="fw-bold {% if product.stock_quantity == 0 %}text-danger{% elif product.is_low_stock %}text-warning{% else %}text-success{% endif %}">
                                    {{ product.stock_quantity }}
                                </span>
                            </td>
                            <td>{{ product.min_stock_level }}</td>
                            <td>KES {{ product.price }}</td>
                            <td>KES {{ product.cost_price }}</td>
                            <td>
                                <span class="fw-semibold">KES {% widthratio product.stock_quantity 1 product.cost_price %}</span>
                            </td>
                            <td>
                                {% if product.stock_quantity == 0 %}
                                    <span class="badge bg-danger">Out of Stock</span>
                                {% elif product.is_low_stock %}
                                    <span class="badge bg-warning">Low Stock</span>
                                {% else %}
                                    <span class="badge bg-success">In Stock</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="quickStockIn({{ product.id }})" title="Stock In">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="quickStockOut({{ product.id }})" title="Stock Out">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <a href="#" class="btn btn-outline-primary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-outline-info" onclick="viewProductHistory({{ product.id }})" title="History">
                                        <i class="fas fa-history"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No products found</h6>
                                <p class="text-muted mb-0">No products match your current filters.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if products.has_other_pages %}
            <div class="p-3 border-top">
                <nav aria-label="Inventory pagination">
                    <ul class="pagination pagination-sm mb-0 justify-content-center">
                        {% if products.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in products.paginator.page_range %}
                            {% if products.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if products.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stock In Modal -->
<div class="modal fade" id="stockInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Stock In
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockInForm">
                    <div class="mb-3">
                        <label class="form-label">Product *</label>
                        <select class="form-select" id="stockInProduct" required>
                            <option value="">Select Product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="stockInQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="stockInNotes" rows="3" placeholder="Reason for stock in..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="processStockIn()">
                    <i class="fas fa-check me-2"></i>Stock In
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stock Out Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-minus me-2"></i>Stock Out
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockOutForm">
                    <div class="mb-3">
                        <label class="form-label">Product *</label>
                        <select class="form-select" id="stockOutProduct" required>
                            <option value="">Select Product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-stock="{{ product.stock_quantity }}">
                                {{ product.name }} ({{ product.sku }}) - {{ product.stock_quantity }} available
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="stockOutQuantity" min="1" required>
                        <div class="form-text">Available: <span id="availableStock">0</span></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <select class="form-select" id="stockOutReason" required>
                            <option value="">Select Reason</option>
                            <option value="damaged">Damaged</option>
                            <option value="expired">Expired</option>
                            <option value="lost">Lost</option>
                            <option value="returned">Returned</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="stockOutNotes" rows="3" placeholder="Additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="processStockOut()">
                    <i class="fas fa-check me-2"></i>Stock Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stock Adjustment Modal -->
<div class="modal fade" id="quickStockModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickStockTitle">Quick Stock Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickStockForm">
                    <input type="hidden" id="quickProductId">
                    <input type="hidden" id="quickStockType">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <div class="fw-semibold" id="quickProductName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quickQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-control" id="quickNotes" placeholder="Quick adjustment reason">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processQuickStock()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function searchInventory() {
    const query = document.getElementById('inventorySearch').value;
    const url = new URL(window.location);
    url.searchParams.set('search', query);
    window.location.href = url.toString();
}

function exportInventory() {
    window.location.href = '#';
}

function quickStockIn(productId) {
    const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
    const productName = productRow ? productRow.querySelector('.fw-semibold').textContent : 'Product';
    
    document.getElementById('quickProductId').value = productId;
    document.getElementById('quickStockType').value = 'in';
    document.getElementById('quickProductName').textContent = productName;
    document.getElementById('quickStockTitle').textContent = 'Quick Stock In';
    document.getElementById('quickQuantity').value = '';
    document.getElementById('quickNotes').value = '';
    
    new bootstrap.Modal(document.getElementById('quickStockModal')).show();
}

function quickStockOut(productId) {
    const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
    const productName = productRow ? productRow.querySelector('.fw-semibold').textContent : 'Product';
    
    document.getElementById('quickProductId').value = productId;
    document.getElementById('quickStockType').value = 'out';
    document.getElementById('quickProductName').textContent = productName;
    document.getElementById('quickStockTitle').textContent = 'Quick Stock Out';
    document.getElementById('quickQuantity').value = '';
    document.getElementById('quickNotes').value = '';
    
    new bootstrap.Modal(document.getElementById('quickStockModal')).show();
}

function processQuickStock() {
    const productId = document.getElementById('quickProductId').value;
    const stockType = document.getElementById('quickStockType').value;
    const quantity = document.getElementById('quickQuantity').value;
    const notes = document.getElementById('quickNotes').value;
    
    if (!quantity || quantity <= 0) {
        alert('Please enter a valid quantity');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: stockType,
        quantity: stockType === 'out' ? -parseInt(quantity) : parseInt(quantity),
        notes: notes
    };
    
    fetch('#', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock updated successfully!', 'success');
            location.reload();
        } else {
            showToast(data.error || 'Failed to update stock', 'danger');
        }
    })
    .catch(error => {
        showToast('An error occurred', 'danger');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('quickStockModal')).hide();
}

function processStockIn() {
    const productId = document.getElementById('stockInProduct').value;
    const quantity = document.getElementById('stockInQuantity').value;
    const notes = document.getElementById('stockInNotes').value;
    
    if (!productId || !quantity) {
        alert('Please fill in all required fields');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: 'in',
        quantity: parseInt(quantity),
        notes: notes
    };
    
    fetch('#', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock added successfully!', 'success');
            location.reload();
        } else {
            showToast(data.error || 'Failed to add stock', 'danger');
        }
    });
    
    bootstrap.Modal.getInstance(document.getElementById('stockInModal')).hide();
}

function processStockOut() {
    const productId = document.getElementById('stockOutProduct').value;
    const quantity = document.getElementById('stockOutQuantity').value;
    const reason = document.getElementById('stockOutReason').value;
    const notes = document.getElementById('stockOutNotes').value;
    
    if (!productId || !quantity || !reason) {
        alert('Please fill in all required fields');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: 'out',
        quantity: -parseInt(quantity),
        notes: `${reason}: ${notes}`
    };
    
    fetch('#', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock removed successfully!', 'success');
            location.reload();
        } else {
            showToast(data.error || 'Failed to remove stock', 'danger');
        }
    });
    
    bootstrap.Modal.getInstance(document.getElementById('stockOutModal')).hide();
}

function viewProductHistory(productId) {
    window.location.href = `#`.replace('0', productId);
}

// Update available stock when product is selected
document.getElementById('stockOutProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const availableStock = selectedOption.dataset.stock || 0;
    document.getElementById('availableStock').textContent = availableStock;
    document.getElementById('stockOutQuantity').max = availableStock;
});

// Search on enter
document.getElementById('inventorySearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchInventory();
    }
});

// Toast notification function
function showToast(message, type) {
    // Implement your toast notification here
    alert(message); // Temporary implementation
}
</script>
{% endblock %}
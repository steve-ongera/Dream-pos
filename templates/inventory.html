{% extends 'base.html' %}
{% load static %}

{% block title %}Inventory Management - Dreams POS{% endblock %}

{% block search_bar %}
<div class="input-group">
    <input type="text" class="form-control search-bar" placeholder="Search products by name or SKU..." 
           id="inventorySearch" value="{{ search_query }}">
    <button class="btn btn-outline-secondary" type="button" onclick="searchInventory()">
        <i class="fas fa-search"></i>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold mb-1">Inventory Management</h4>
                <p class="text-muted mb-0">Manage your product stock and inventory levels</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#stockInModal">
                    <i class="fas fa-plus me-2"></i>Stock In
                </button>
                <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#stockOutModal">
                    <i class="fas fa-minus me-2"></i>Stock Out
                </button>
                <button class="btn btn-outline-primary" onclick="exportInventory()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="fas fa-plus me-2"></i>Add Product
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="bg-white rounded-3 p-3 shadow-sm mb-4">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Category</label>
                    <select class="form-select" name="category" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Stock Status</label>
                    <select class="form-select" name="stock_status" onchange="this.form.submit()">
                        <option value="">All Products</option>
                        <option value="low_stock" {% if stock_status == 'low_stock' %}selected{% endif %}>Low Stock</option>
                        <option value="out_of_stock" {% if stock_status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                        <option value="in_stock" {% if stock_status == 'in_stock' %}selected{% endif %}>In Stock</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sort By</label>
                    <select class="form-select" name="sort_by" onchange="this.form.submit()">
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="-name" {% if sort_by == '-name' %}selected{% endif %}>Name (Z-A)</option>
                        <option value="stock_quantity" {% if sort_by == 'stock_quantity' %}selected{% endif %}>Stock (Low to High)</option>
                        <option value="-stock_quantity" {% if sort_by == '-stock_quantity' %}selected{% endif %}>Stock (High to Low)</option>
                        <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price (Low to High)</option>
                        <option value="-price" {% if sort_by == '-price' %}selected{% endif %}>Price (High to Low)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Product name or SKU" value="{{ search_query }}">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Inventory Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-boxes text-primary fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Total Products</h6>
                            <h4 class="fw-bold text-primary mb-0">{{ products|length }}</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-check-circle text-success fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">In Stock</h6>
                            <h4 class="fw-bold text-success mb-0" id="inStockCount">0</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-exclamation-triangle text-warning fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Low Stock</h6>
                            <h4 class="fw-bold text-warning mb-0" id="lowStockCount">0</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bg-white rounded-3 p-3 shadow-sm">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3 me-3">
                            <i class="fas fa-times-circle text-danger fa-lg"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">Out of Stock</h6>
                            <h4 class="fw-bold text-danger mb-0" id="outOfStockCount">0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="bg-white rounded-3 shadow-sm">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0">Products Inventory</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-secondary active" data-view="table">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="btn btn-outline-secondary" data-view="grid">
                        <i class="fas fa-th-large"></i>
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Min. Level</th>
                            <th>Unit Price</th>
                            <th>Cost Price</th>
                            <th>Stock Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr data-product-id="{{ product.id }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if product.image %}
                                        <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                                             class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light rounded me-3 d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-semibold">{{ product.name }}</div>
                                        {% if product.description %}
                                            <small class="text-muted">{{ product.description|truncatechars:30 }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ product.sku }}</span>
                            </td>
                            <td>{{ product.category.name }}</td>
                            <td>
                                <span class="fw-bold stock-quantity {% if product.stock_quantity == 0 %}text-danger{% elif product.is_low_stock %}text-warning{% else %}text-success{% endif %}">
                                    {{ product.stock_quantity }}
                                </span>
                            </td>
                            <td>{{ product.min_stock_level }}</td>
                            <td>KES {{ product.price }}</td>
                            <td>KES {{ product.cost_price }}</td>
                            <td>
                                <span class="fw-semibold stock-value">KES {% widthratio product.stock_quantity 1 product.cost_price %}</span>
                            </td>
                            <td>
                                <span class="stock-status badge {% if product.stock_quantity == 0 %}bg-danger{% elif product.is_low_stock %}bg-warning{% else %}bg-success{% endif %}">
                                    {% if product.stock_quantity == 0 %}Out of Stock{% elif product.is_low_stock %}Low Stock{% else %}In Stock{% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="quickStockIn({{ product.id }}, '{{ product.name }}')" title="Stock In">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="quickStockOut({{ product.id }}, '{{ product.name }}', {{ product.stock_quantity }})" title="Stock Out">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <a href="#" class="btn btn-outline-primary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-outline-info" onclick="viewProductHistory({{ product.id }})" title="History">
                                        <i class="fas fa-history"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                                <h6 class="text-muted">No products found</h6>
                                <p class="text-muted mb-0">No products match your current filters.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if products.has_other_pages %}
            <div class="p-3 border-top">
                <nav aria-label="Inventory pagination">
                    <ul class="pagination pagination-sm mb-0 justify-content-center">
                        {% if products.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for num in products.paginator.page_range %}
                            {% if products.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if products.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ products.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add New Product
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="productSku" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit Price *</label>
                                <input type="number" class="form-control" id="productPrice" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cost Price</label>
                                <input type="number" class="form-control" id="productCostPrice" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Initial Stock</label>
                                <input type="number" class="form-control" id="productStock" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Min Stock Level</label>
                                <input type="number" class="form-control" id="productMinStock" min="0" value="5">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">
                    <i class="fas fa-save me-2"></i>Save Product
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stock In Modal -->
<div class="modal fade" id="stockInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Stock In
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockInForm">
                    <div class="mb-3">
                        <label class="form-label">Product *</label>
                        <select class="form-select" id="stockInProduct" required>
                            <option value="">Select Product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{{ product.name }} ({{ product.sku }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="stockInQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="stockInNotes" rows="3" placeholder="Reason for stock in..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="processStockIn()">
                    <i class="fas fa-check me-2"></i>Stock In
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stock Out Modal -->
<div class="modal fade" id="stockOutModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-minus me-2"></i>Stock Out
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockOutForm">
                    <div class="mb-3">
                        <label class="form-label">Product *</label>
                        <select class="form-select" id="stockOutProduct" required>
                            <option value="">Select Product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-stock="{{ product.stock_quantity }}">
                                {{ product.name }} ({{ product.sku }}) - {{ product.stock_quantity }} available
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity *</label>
                        <input type="number" class="form-control" id="stockOutQuantity" min="1" required>
                        <div class="form-text">Available: <span id="availableStock">0</span></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason *</label>
                        <select class="form-select" id="stockOutReason" required>
                            <option value="">Select Reason</option>
                            <option value="damaged">Damaged</option>
                            <option value="expired">Expired</option>
                            <option value="lost">Lost</option>
                            <option value="returned">Returned</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="stockOutNotes" rows="3" placeholder="Additional details..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="processStockOut()">
                    <i class="fas fa-check me-2"></i>Stock Out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stock Adjustment Modal -->
<div class="modal fade" id="quickStockModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickStockTitle">Quick Stock Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickStockForm">
                    <input type="hidden" id="quickProductId">
                    <input type="hidden" id="quickStockType">
                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <div class="fw-semibold" id="quickProductName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="quickQuantity" min="1" required>
                        <div class="form-text" id="quickAvailableStock" style="display: none;">Available: <span></span></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-control" id="quickNotes" placeholder="Quick adjustment reason">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processQuickStock()">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Product History Modal -->
<div class="modal fade" id="productHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history me-2"></i>Product History
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="productHistoryContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF token for AJAX requests
const csrfToken = '{{ csrf_token }}';

// Calculate and update stock counts on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStockCounts();
});

function updateStockCounts() {
    let inStock = 0, lowStock = 0, outOfStock = 0;
    
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const stockElement = row.querySelector('.stock-quantity');
        const stockValue = parseInt(stockElement.textContent.trim());
        
        if (stockValue === 0) {
            outOfStock++;
        } else if (stockElement.classList.contains('text-warning')) {
            lowStock++;
        } else {
            inStock++;
        }
    });
    
    document.getElementById('inStockCount').textContent = inStock;
    document.getElementById('lowStockCount').textContent = lowStock;
    document.getElementById('outOfStockCount').textContent = outOfStock;
}

function searchInventory() {
    const query = document.getElementById('inventorySearch').value;
    const url = new URL(window.location);
    url.searchParams.set('search', query);
    window.location.href = url.toString();
}

function exportInventory() {
    showLoadingToast('Preparing export...');
    window.location.href = '{% url "export_inventory" %}';
}

function addProduct() {
    const formData = {
        name: document.getElementById('productName').value.trim(),
        sku: document.getElementById('productSku').value.trim(),
        category_id: document.getElementById('productCategory').value,
        description: document.getElementById('productDescription').value.trim(),
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        cost_price: parseFloat(document.getElementById('productCostPrice').value) || 0,
        stock_quantity: parseInt(document.getElementById('productStock').value) || 0,
        min_stock_level: parseInt(document.getElementById('productMinStock').value) || 5
    };
    
    // Basic validation
    if (!formData.name || !formData.sku || !formData.category_id || !formData.price) {
        showToast('Please fill in all required fields', 'danger');
        return;
    }
    
    fetch('{% url "add_product" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Product added successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            location.reload();
        } else {
            showToast(data.error || 'Failed to add product', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred', 'danger');
    });
}

function quickStockIn(productId, productName) {
    document.getElementById('quickProductId').value = productId;
    document.getElementById('quickStockType').value = 'in';
    document.getElementById('quickProductName').textContent = productName;
    document.getElementById('quickStockTitle').textContent = 'Quick Stock In';
    document.getElementById('quickQuantity').value = '';
    document.getElementById('quickNotes').value = '';
    document.getElementById('quickAvailableStock').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('quickStockModal')).show();
}

function quickStockOut(productId, productName, currentStock) {
    document.getElementById('quickProductId').value = productId;
    document.getElementById('quickStockType').value = 'out';
    document.getElementById('quickProductName').textContent = productName;
    document.getElementById('quickStockTitle').textContent = 'Quick Stock Out';
    document.getElementById('quickQuantity').value = '';
    document.getElementById('quickQuantity').max = currentStock;
    document.getElementById('quickNotes').value = '';
    
    const availableStockDiv = document.getElementById('quickAvailableStock');
    availableStockDiv.style.display = 'block';
    availableStockDiv.querySelector('span').textContent = currentStock;
    
    new bootstrap.Modal(document.getElementById('quickStockModal')).show();
}

function processQuickStock() {
    const productId = document.getElementById('quickProductId').value;
    const stockType = document.getElementById('quickStockType').value;
    const quantity = parseInt(document.getElementById('quickQuantity').value);
    const notes = document.getElementById('quickNotes').value;
    
    if (!quantity || quantity <= 0) {
        showToast('Please enter a valid quantity', 'danger');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: stockType,
        quantity: quantity,
        notes: notes || `Quick ${stockType === 'in' ? 'stock in' : 'stock out'}`
    };
    
    fetch('{% url "update_inventory" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock updated successfully!', 'success');
            updateProductRow(productId, data.new_stock, data.is_low_stock);
            bootstrap.Modal.getInstance(document.getElementById('quickStockModal')).hide();
            updateStockCounts();
        } else {
            showToast(data.error || 'Failed to update stock', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred', 'danger');
    });
}

function processStockIn() {
    const productId = document.getElementById('stockInProduct').value;
    const quantity = parseInt(document.getElementById('stockInQuantity').value);
    const notes = document.getElementById('stockInNotes').value;
    
    if (!productId || !quantity) {
        showToast('Please fill in all required fields', 'danger');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: 'in',
        quantity: quantity,
        notes: notes || 'Stock in'
    };
    
    fetch('{% url "update_inventory" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock added successfully!', 'success');
            updateProductRow(productId, data.new_stock, data.is_low_stock);
            bootstrap.Modal.getInstance(document.getElementById('stockInModal')).hide();
            document.getElementById('stockInForm').reset();
            updateStockCounts();
        } else {
            showToast(data.error || 'Failed to add stock', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred', 'danger');
    });
}

function processStockOut() {
    const productId = document.getElementById('stockOutProduct').value;
    const quantity = parseInt(document.getElementById('stockOutQuantity').value);
    const reason = document.getElementById('stockOutReason').value;
    const notes = document.getElementById('stockOutNotes').value;
    
    if (!productId || !quantity || !reason) {
        showToast('Please fill in all required fields', 'danger');
        return;
    }
    
    const data = {
        product_id: productId,
        transaction_type: 'out',
        quantity: quantity,
        notes: `${reason}: ${notes}`.trim()
    };
    
    fetch('{% url "update_inventory" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Stock removed successfully!', 'success');
            updateProductRow(productId, data.new_stock, data.is_low_stock);
            bootstrap.Modal.getInstance(document.getElementById('stockOutModal')).hide();
            document.getElementById('stockOutForm').reset();
            updateStockCounts();
        } else {
            showToast(data.error || 'Failed to remove stock', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred', 'danger');
    });
}

function viewProductHistory(productId) {
    const modal = new bootstrap.Modal(document.getElementById('productHistoryModal'));
    modal.show();
    
    // Reset content
    document.getElementById('productHistoryContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    fetch(`{% url "product_history" 0 %}`.replace('0', productId))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let historyHtml = `
                <div class="mb-3">
                    <h6 class="fw-bold">${data.product_name}</h6>
                    <p class="text-muted mb-0">Current Stock: <span class="fw-bold">${data.current_stock}</span></p>
                </div>
            `;
            
            if (data.history.length > 0) {
                historyHtml += `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Notes</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.history.forEach(record => {
                    const quantityClass = record.quantity > 0 ? 'text-success' : 'text-danger';
                    const quantitySign = record.quantity > 0 ? '+' : '';
                    
                    historyHtml += `
                        <tr>
                            <td>${record.date}</td>
                            <td>${record.type}</td>
                            <td class="${quantityClass}">${quantitySign}${record.quantity}</td>
                            <td>${record.notes || '-'}</td>
                            <td>${record.user}</td>
                        </tr>
                    `;
                });
                
                historyHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                historyHtml += `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p>No history records found</p>
                    </div>
                `;
            }
            
            document.getElementById('productHistoryContent').innerHTML = historyHtml;
        } else {
            document.getElementById('productHistoryContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Failed to load history'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('productHistoryContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                An error occurred while loading history
            </div>
        `;
    });
}

function updateProductRow(productId, newStock, isLowStock) {
    const row = document.querySelector(`tr[data-product-id="${productId}"]`);
    if (!row) return;
    
    // Update stock quantity
    const stockElement = row.querySelector('.stock-quantity');
    stockElement.textContent = newStock;
    
    // Update stock quantity styling
    stockElement.className = 'fw-bold stock-quantity';
    if (newStock === 0) {
        stockElement.classList.add('text-danger');
    } else if (isLowStock) {
        stockElement.classList.add('text-warning');
    } else {
        stockElement.classList.add('text-success');
    }
    
    // Update status badge
    const statusElement = row.querySelector('.stock-status');
    statusElement.className = 'stock-status badge';
    if (newStock === 0) {
        statusElement.classList.add('bg-danger');
        statusElement.textContent = 'Out of Stock';
    } else if (isLowStock) {
        statusElement.classList.add('bg-warning');
        statusElement.textContent = 'Low Stock';
    } else {
        statusElement.classList.add('bg-success');
        statusElement.textContent = 'In Stock';
    }
    
    // Update stock value (assuming cost price calculation)
    const costPriceText = row.querySelector('td:nth-child(7)').textContent;
    const costPrice = parseFloat(costPriceText.replace('KES ', '')) || 0;
    const stockValue = newStock * costPrice;
    row.querySelector('.stock-value').textContent = `KES ${stockValue.toFixed(2)}`;
}

// Update available stock when product is selected in stock out modal
document.getElementById('stockOutProduct').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const availableStock = selectedOption.dataset.stock || 0;
    document.getElementById('availableStock').textContent = availableStock;
    document.getElementById('stockOutQuantity').max = availableStock;
});

// Search on enter key
document.getElementById('inventorySearch').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchInventory();
    }
});

// Toast notification functions
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type}" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${getToastIcon(type)} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

function showLoadingToast(message) {
    showToast(`<div class="spinner-border spinner-border-sm me-2" role="status"></div>${message}`, 'primary');
}

function getToastIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle',
        'primary': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Clear form when modals are hidden
document.getElementById('addProductModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('addProductForm').reset();
});

document.getElementById('stockInModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('stockInForm').reset();
});

document.getElementById('stockOutModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('stockOutForm').reset();
    document.getElementById('availableStock').textContent = '0';
});
</script>
{% endblock %}